os:
  - linux

dist: bionic

sudo: required

env:
  global:
    - NAME=lychee-laravel
    - REPO=lycheeorg/lychee-laravel
  matrix:
    - secure: "RoLFuaYrnXxTAAsO7wKP2lpFYloMu+u7S0tnaJBahnQB8tSMgroFKuipqktf/TrlZWoOQqeWPn7npOsTTw95HZWThAOQYuoAiPo1HlzPtnMlxCh9H0NuiNi/X71FmM4HHr5hqCRWs9RxuSyH9XTUq/rS7UHLkFJM+eAlgendx1JLlz0+VKwUPOhxkzirBQNWETEs6srN0kS4TpIgNvEFMhYIPtmi38wkXn/q3GwNgk2SpJToPgqbPEvWuTzSZuGTVKOlmIRaV0I81AEeP29bLR5Goegvq6kJw1lZeqGTv3zVaG2gJJAy58BUSap3N733DBQ3EXHzdpsZ4coPxcoHyFw7TpFdejCFhcBxyRo/HlOeovi6ZLqtlMxFOmxBYmMauj3BVlFiPAO/seUufzXBiaMsCsozlhKYbXfOAQ7QFqhvuwyVI8qpdpS+NrhS7Z5rIbAIib/qBFBwKTobm08owT0oDISqTey/sNbRQjMdRbCNZm2ZP1UOVM3yW5K7PVCn5dJSt/OaoAeM3fCOHq6F2eWjmN8cz25yBH8I/zdpkcrk10SZMynG7os1WVIyzJqKva1+byQ45QryqozcsOwizgAghjPEtApgEMyG0PV1DFlKn8iahKC/6JDFlmUlYnH6yukJkNEjvXjhV8x7g05v0RuAKLbc5htvxlRhsjkhZ58="

language: php

php:
  - '7.3'

services:
  - docker

addons:
  mariadb: '10.3'

before_install:
  - mysql -e 'create database homestead_test;'
  - chmod +x deploy.sh

install:
  - docker build --pull -t $REPO':'$TRAVIS_BUILD_NUMBER .
  - docker run -d --name=$NAME -e PUID=1000 -e PGID=1000 -e PHP_TZ=America/New_York
    -e DB_CONNECTION=mysql -e DB_HOST=mariadb -e DB_PORT=3306 -e DB_DATABASE=homestead_test
    -e DB_USERNAME=root -e DB_PASSWORD= -p 127.0.0.1:80:80 $REPO':'$TRAVIS_BUILD_NUMBER

before_script:

script:
  - docker ps -a | awk '{print $NF}' | grep -w $NAME | cat

# after_success:
#   - ./deploy.sh
deploy:
  - provider: script
    script: ./deploy.sh
    skip_cleanup: true
    on:
      branch: master
  - provider: script
    script: ./deploy.sh
    skip_cleanup: true
    on:
      tags: true
  - provider: script
    script: ./deploy.sh
    skip_cleanup: true
    on:
      all_branches: true

after_script:
  - docker stop $NAME && docker rm $NAME
